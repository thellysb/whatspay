<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Integração PUSHIN PAY</title>
  <style>
    /* ... Seu CSS original permanece igual ... */
    /* Por espaço, mantive o CSS como está no seu código anterior */
  </style>
</head>
<body>

  <div class="header">
    <div class="profile"></div>
    <div class="logo">
      <img src="https://i.postimg.cc/W4vfqs5G/whatsapp-33.png" alt="Logo">
    </div>
  </div>

  <div class="container">
    <h1 class="valor-title">Whatsapp Pay</h1>
    <p class="info-text">Realize o pagamento via PIX de forma rápida e segura.</p>

    <label for="valorInput">Valor:</label>
    <input type="text" id="valorInput" placeholder="Digite o Valor" style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px;">

    <button id="gerarPixBtn">Gerar Pix</button>

    <div id="mensagem"></div>
    <div id="qrCodeContainer"></div>

    <div class="codigo-container" id="codigoPix">
      <span><strong></strong></span>
    </div>

    <div id="statusPagamento"></div>
    <div id="verificado"></div>
  </div>

  <!-- Pop-up de carregamento -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <h2>Carregando... Aguarde enquanto confirmamos seu pagamento.</h2>
  </div>

  <script>
    let transacaoId = null; // Armazenar ID da transação globalmente

    const enviarMensagem = (mensagem) => {
      const mensagemDiv = document.getElementById('mensagem');
      mensagemDiv.innerHTML += `<p>${mensagem}</p>`;
    };

    const formatarValor = (valor) => {
      return valor.replace(',', '.').replace(/[^\d.]/g, '');
    };

    const gerarPix = async () => {
      let valor = formatarValor(document.getElementById('valorInput').value);
      valor = parseFloat(valor);

      if (isNaN(valor) || valor <= 0) {
        enviarMensagem("Por favor, insira um valor válido.");
        return;
      }

      const valorEmCentavos = Math.round(valor * 100);

      const response = await fetch("https://api.pushinpay.com.br/api/pix/cashIn", {
        method: "POST",
        headers: {
          "Authorization": "Bearer 22753|pPN7WD8FpR1OWe1tSfBxWL3twjz3GwQOi5Tvmbme6925d1e2",
          "Accept": "application/json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          "value": valorEmCentavos,
          "webhook_url": "http://seuservico.com/webhook"
        })
      });

      if (response.ok) {
        const data = await response.json();
        transacaoId = data.id;

        apresentarQRCode(data.qr_code_base64);
        apresentarCodigoCopiaCola(data.qr_code);
        verificarPagamento(transacaoId);
      } else {
        enviarMensagem("Erro ao gerar PIX: " + response.statusText);
      }
    };

    const apresentarQRCode = (qrCodeBase64) => {
      const imgQrCode = document.createElement("img");
      imgQrCode.src = qrCodeBase64;
      imgQrCode.style.maxWidth = "150px";
      const qrCodeContainer = document.getElementById('qrCodeContainer');
      qrCodeContainer.innerHTML = "";
      qrCodeContainer.appendChild(imgQrCode);
    };

    const apresentarCodigoCopiaCola = (codigo) => {
      const codigoDiv = document.getElementById('codigoPix');
      codigoDiv.querySelector("strong").innerText = codigo;

      const botaoExistente = codigoDiv.querySelector(".botaoCopiar");
      if (botaoExistente) botaoExistente.remove();

      const botaoCopiar = document.createElement("button");
      botaoCopiar.className = "botaoCopiar";
      botaoCopiar.innerText = "Copiar Código";
      botaoCopiar.onclick = () => copiarCodigo(codigo);
      codigoDiv.appendChild(botaoCopiar);
    };

    const copiarCodigo = async (codigo) => {
      await navigator.clipboard.writeText(codigo);
      enviarMensagem("PUSHIN PAY – Código copiado com sucesso!");

      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.style.visibility = 'visible';

      if (transacaoId) {
        verificarPagamento(transacaoId); // Usa sempre o ID correto
      }
    };

    const verificarPagamento = (idTransacao) => {
      const statusDiv = document.getElementById('statusPagamento');
      statusDiv.innerHTML = "Aguardando pagamento...";

      const intervalId = setInterval(async () => {
        const response = await fetch(`https://api.pushinpay.com.br/api/transactions/${idTransacao}`, {
          method: "GET",
          headers: {
            "Authorization": "Bearer 17795|RQ3ZvjijonWrRsxwmflUI5zmJOgZXjf0hGPyURPT9da8f3ac",
            "Accept": "application/json",
            "Content-Type": "application/json"
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log("Status retornado:", data.status);

          if (["paid", "approved", "success"].includes(data.status)) {
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            const mensagemDiv = document.getElementById('mensagem');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const verificadoDiv = document.getElementById('verificado');

            qrCodeContainer.innerHTML = "";
            mensagemDiv.innerHTML = "";
            statusDiv.innerHTML = "Pagamento aprovado!";
            loadingOverlay.style.visibility = 'hidden';

            verificadoDiv.innerHTML = `
              <img src="https://i.postimg.cc/pdYrVCBT/canva.png" alt="Pagamento Verificado" style="max-width: 150px;"/>
            `;

            const codigoDiv = document.getElementById('codigoPix');
            codigoDiv.querySelector("strong").innerText = "";
            const botaoCopiar = codigoDiv.querySelector(".botaoCopiar");
            if (botaoCopiar) botaoCopiar.remove();

            const botaoLiberado = document.createElement("button");
            botaoLiberado.className = "botaoLiberado";
            botaoLiberado.innerText = "Acesso Liberado";
            botaoLiberado.onclick = () => {
              window.location.href = "https://api.whatsapp.com/send/";
            };
            verificadoDiv.appendChild(botaoLiberado);

            clearInterval(intervalId);
          }
        } else {
          enviarMensagem("Erro ao verificar pagamento: " + response.statusText);
          clearInterval(intervalId);
        }
      }, 5000); // Verifica a cada 5 segundos
    };

    document.getElementById('gerarPixBtn').onclick = gerarPix;
  </script>
</body>
</html>
